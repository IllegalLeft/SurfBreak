; Graphics Routines

.INCLUDE "nes.i"
.INCLUDE "rommap.i"
.INCLUDE "ram.i"


.SECTION "Graphics Routines"

WaitVBlank:
	inc sleeping
-	lda sleeping
	bne -
	rts

LoadPalette:
	lda PPUSTATUS
	lda #$3F
	sta PPUADDR
	lda #$00
	sta PPUADDR

	ldx #$00
-   lda Palettes.w, x
	sta PPUDATA
	inx
	cpx #$20
	bne -
	rts

LoadScreen:
.define src		scratch
	lda #<Map				; setup map src
	sta src
	lda #>Map
	sta src+1
	lda PPUSTATUS
	lda #$20
	sta PPUADDR
	lda #$00
	sta PPUADDR
mvfwd:
	ldy #0
	ldx #3+1
	beq @frag
@page:
	lda (src), y
	sta PPUDATA
	iny
	bne @page
	inc src+1
	dex
	bne @page
@frag:
	cpy #0
	beq @done
	lda (src), y
	sta PPUDATA
	iny
	bne @frag
@done:
	rts

InitPlayerSprite:
	; set tile IDs
	lda #1
	sta OAM.5.tile
	lda #3
	sta OAM.6.tile
	;lda #2
	;sta OAM.7.tile
	;lda #3
	;sta OAM.8.tile
	
	; set attributes
	lda #%00000000
	sta OAM.5.attr
	sta OAM.6.attr
	;sta OAM.7.attr
	;sta OAM.8.attr
	
UpdatePlayerPos:
	lda player.y
	sta scratch
	lda player.y+1
	sta scratch+1
.REPEAT 4
	lsr scratch+1
	ror scratch
.ENDR
	lda scratch

	; set y ordinate
	sta OAM.5.y
	sta OAM.6.y
	
	; set x ordinate
	lda player.x
	sta OAM.5.x
	clc
	adc #8
	sta OAM.6.x
	rts

; 	y - enemy index (source)
SpawnEnemy:
	lda #1
	sta EnemyState, y		; set state
	lda #80
	sta EnemyX, y			; set x
	sta EnemyY, y			; set y
	tya
	asl
	tay
	lda #<SprShark
	sta EnemyTiles, y		; set tiles address
	lda #>SprShark
	sta EnemyTiles+1, y
	rts

; 	x - enemy index (source)
; 	scratch 2	- OAM buffer destination offset
DrawEnemy:
	lda EnemyState, x
	beq @end				; if state is 0, we're done here

	ldy scratch+2

	; y ordinate
	lda EnemyY, x
	sta OAM.1.y, y
	sta OAM.2.y, y

	; x ordinate
	lda EnemyX, x
	sta OAM.1.x, y
	clc
	adc #8
	sta OAM.2.x, y

	; tile indices
	lda EnemyTiles, x		; load address into scratch
	sta scratch
	lda EnemyTiles+1, x
	sta scratch+1
	ldy #0
	ldx scratch+2
	lda (scratch), y		; load from address
	sta OAM.1.tile, x
	iny
	lda (scratch), y
	sta OAM.2.tile, x
	ldy scratch+2

	; attributes
	lda #%00000001
	sta OAM.1.attr, y
	sta OAM.2.attr, y

@end:
	rts


.ENDS
    

.SECTION "Graphics Data"

Palettes:
	.db $11,$27,$30,$37
	.db $11,$0c,$2c,$30
	.db $11,$21,$30,$3d
	.db $11,$0b,$1a,$30

	.db $11,$2a,$36,$15
	.db $11,$01,$00,$10
	.db $11,$12,$23,$34
	.db $11,$13,$24,$35	

; Sprites
SprPlayer:
	.db $01, $03
SprShark:
	.db $05, $07
	

; Maps
Map:
	.db $01,$01,$20,$21,$22,$23,$24,$25,$26,$27,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01
	.db $01,$01,$30,$31,$32,$33,$34,$35,$36,$37,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01
	.db $01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$20,$21,$22,$23,$24,$25,$26,$27,$01,$01,$01,$01,$01,$01
	.db $01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$30,$31,$32,$33,$34,$35,$36,$37,$01,$01,$01,$01,$01,$01
	.db $01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01
	.db $01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01
	.db $0c,$0d,$0c,$0d,$0c,$0d,$0c,$0d,$0c,$0d,$28,$29,$28,$29,$28,$29,$0c,$0d,$0c,$0d,$0c,$0d,$0c,$0d,$0c,$0d,$0c,$0d,$0c,$0d,$0c,$0d
	.db $1c,$1d,$1c,$1d,$1c,$1d,$1c,$1d,$1c,$1d,$38,$39,$38,$39,$38,$39,$1c,$1d,$1c,$1d,$1c,$1d,$1c,$1d,$1c,$1d,$1c,$1d,$1c,$1d,$1c,$1d
	.db $11,$11,$11,$11,$11,$11,$11,$11,$2a,$3a,$0e,$0f,$0e,$0f,$0e,$0f,$0e,$0f,$0e,$0f,$0e,$0f,$0e,$0f,$0e,$0f,$0e,$0f,$0e,$0f,$0e,$0f
	.db $11,$11,$11,$11,$11,$11,$11,$11,$3a,$3b,$1e,$1f,$1e,$1f,$1e,$1f,$1e,$1f,$1e,$1f,$1e,$1f,$1e,$1f,$1e,$1f,$1e,$1f,$1e,$1f,$1e,$1f
	.db $11,$11,$11,$11,$11,$11,$2a,$3a,$2c,$2d,$0a,$0b,$0a,$0b,$0a,$0b,$0a,$0b,$0a,$0b,$0a,$0b,$0a,$0b,$0a,$0b,$0a,$0b,$0a,$0b,$0a,$0b
	.db $11,$11,$11,$11,$11,$11,$3a,$3b,$3c,$3d,$1a,$1b,$1a,$1b,$1a,$1b,$1a,$1b,$1a,$1b,$1a,$1b,$1a,$1b,$1a,$1b,$1a,$1b,$1a,$1b,$1a,$1b
	.db $11,$11,$11,$11,$2a,$3a,$2c,$2d,$10,$10,$10,$10,$10,$10,$10,$10,$10,$10,$10,$10,$10,$10,$10,$10,$10,$10,$10,$10,$10,$10,$10,$10
	.db $11,$11,$11,$11,$3a,$3b,$3c,$3d,$10,$10,$10,$10,$10,$10,$10,$10,$10,$10,$10,$10,$10,$10,$10,$10,$10,$10,$10,$10,$10,$10,$10,$10
	.db $2e,$2f,$2a,$3a,$2c,$2d,$08,$09,$08,$09,$08,$09,$08,$09,$08,$09,$08,$09,$08,$09,$08,$09,$08,$09,$08,$09,$08,$09,$08,$09,$08,$09
	.db $3e,$3f,$3a,$3b,$3c,$3d,$18,$19,$18,$19,$18,$19,$18,$19,$18,$19,$18,$19,$18,$19,$18,$19,$18,$19,$18,$19,$18,$19,$18,$19,$18,$19
	.db $00,$00,$00,$00,$00,$00,$00,$00,$fe,$ff,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
	.db $00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
	.db $00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
	.db $00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
	.db $00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
	.db $00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
	.db $00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
	.db $00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
	.db $04,$05,$06,$07,$04,$05,$06,$07,$04,$05,$06,$07,$04,$05,$06,$07,$04,$05,$06,$07,$04,$05,$06,$07,$04,$05,$06,$07,$04,$05,$06,$07
	.db $14,$15,$16,$17,$14,$15,$16,$17,$14,$15,$16,$17,$14,$15,$16,$17,$14,$15,$16,$17,$14,$15,$16,$17,$14,$15,$16,$17,$14,$15,$16,$17
	.db $11,$11,$11,$11,$11,$11,$11,$11,$11,$11,$11,$11,$11,$11,$11,$11,$11,$11,$11,$11,$11,$11,$11,$11,$11,$11,$11,$11,$11,$11,$11,$11
	.db $11,$11,$11,$11,$11,$11,$11,$11,$11,$11,$11,$11,$11,$11,$11,$11,$11,$11,$11,$11,$11,$11,$11,$11,$11,$11,$11,$11,$11,$11,$11,$11
	.db $11,$03,$03,$02,$02,$03,$02,$03,$02,$03,$02,$03,$02,$03,$02,$03,$02,$03,$02,$03,$02,$03,$02,$03,$02,$03,$02,$03,$02,$03,$02,$03
	.db $12,$13,$13,$12,$12,$13,$12,$13,$12,$13,$12,$13,$12,$13,$12,$13,$12,$13,$12,$13,$12,$13,$12,$13,$12,$13,$12,$13,$12,$13,$12,$13

	.db $aa,$aa,$aa,$aa,$aa,$aa,$aa,$aa,$5a,$5a,$5a,$5a,$5a,$5a,$5a,$5a
	.db $55,$55,$55,$55,$55,$55,$55,$55,$55,$55,$55,$55,$55,$55,$55,$55
	.db $00,$00,$01,$00,$00,$00,$50,$00,$00,$00,$00,$00,$00,$45,$55,$00
	.db $00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00

.ENDS